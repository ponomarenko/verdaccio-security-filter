# Verdaccio Configuration with Full Security Filter Protection
# Dual-layer implementation - Middleware + Filter Metadata
# Compatible with Verdaccio 6.x and 7.x

# Storage and plugins
storage: ./storage
plugins: ./plugins

# LAYER 1: Filter Metadata (CVE, License, Age checks)
# LAYER 2: Middleware (Whitelist, Pattern, Scope, Tarball blocking)

# Package access control
packages:
  '@*/*':
    access: $all
    publish: $authenticated
    unpublish: $authenticated
    proxy: npmjs
    storage: security-filter  # Enable filter_metadata

  '**':
    access: $all
    publish: $authenticated
    unpublish: $authenticated
    proxy: npmjs
    storage: security-filter  # Enable filter_metadata

# Security Filter Configuration - DUAL LAYER
middlewares:
  security-filter:
    enabled: true

    # Basic filtering mode
    mode: whitelist

    # Whitelist configuration
    whitelist:
      packages:
        - lodash
        - express
        - react
        - vue
      patterns:
        - "^@types/.*"        # Allow all TypeScript types
        - "^@babel/.*"        # Allow Babel packages

    # CVE Vulnerability Checking (Layer 1 - filter_metadata)
    cveCheck:
      enabled: true
      databases:
        - osv                  # Open Source Vulnerabilities
      severity:
        - critical
        - high
      autoBlock: true          # Automatically block vulnerable packages
      updateInterval: 24       # Hours between cache updates

    # License Compliance (Layer 1 - filter_metadata)
    licenses:
      allowed:
        - MIT
        - Apache-2.0
        - BSD-2-Clause
        - BSD-3-Clause
        - ISC
      blocked:
        - GPL-3.0             # Exclude GPL
        - AGPL-3.0            # Exclude AGPL
      requireLicense: true    # Block packages without license

    # Package Age Verification (Layer 1 - filter_metadata)
    packageAge:
      enabled: true
      minPackageAgeDays: 7    # Package must be at least 7 days old
      minVersionAgeDays: 3    # Version must be at least 3 days old
      warnOnly: false         # Block (not just warn)

    # Version blocking (Layer 2 - middleware)
    blockedVersions:
      - "lodash@4.17.20"      # Known vulnerable version
      - "minimist@1.2.5"      # Prototype pollution

    # Version range rules (Layer 2 - middleware)
    versionRangeRules:
      - package: "minimist"
        range: "0.0.0 - 1.2.5"
        strategy: "block"
        reason: "Prototype pollution vulnerability"
      - package: "node-fetch"
        range: "< 2.6.7"
        strategy: "block"
        reason: "Information disclosure vulnerability"

    # Pattern-based blocking (Layer 2 - middleware)
    blockedPatterns:
      - "^evil-.*"
      - ".*-malicious$"
      - "^hack-.*"

    # Scope control (Layer 2 - middleware)
    blockedScopes:
      - "@malicious"
      - "@dangerous"

    # Enhanced logging
    logger:
      level: info             # debug, info, warn, error
      enabled: true
      includeTimestamp: true

    # Metrics collection
    metrics:
      enabled: true
      path: ./security-metrics.jsonl

# Web UI settings
web:
  title: Verdaccio with Full Security Protection

# Authentication
auth:
  htpasswd:
    file: ./htpasswd

# Uplinks
uplinks:
  npmjs:
    url: https://registry.npmjs.org/

# Server settings
server:
  keepAliveTimeout: 60

# Logging
log:
  type: stdout
  format: pretty
  level: info
